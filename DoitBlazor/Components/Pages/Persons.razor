@page "/persons"
@rendermode InteractiveServer
@inject ITodoService TodoService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@using DoitBlazor.Configuration

<PageTitle>@AppConfig.BrandName - Contacts</PageTitle>

<AuthorizeView>
    <Authorized Context="authContext">
        <div class="task-input-bar">
            <input type="text" 
                   placeholder="Add new contact..." 
                   @bind="quickPersonName"
                   @bind:event="oninput"
                   @onkeydown="HandleInputKeyDown" />
            <span class="late-indicator">@persons?.Count contacts</span>
        </div>

        @if (persons == null)
        {
            <div style="padding: 2rem; text-align: center;">
                <em>Loading...</em>
            </div>
        }
        else
        {
            <div class="task-list-compact">
                <ul>
                    @foreach (var person in persons.Where(p => p.Status == 0).OrderBy(p => p.FamilyName).ThenBy(p => p.GivenName))
                    {
                        <li class="task-item-compact">
                            <span class="person-icon">ðŸ‘¤</span>
                            <label @onclick="@(() => OpenEditPersonModal(person))">
                                @(string.IsNullOrWhiteSpace(person.GivenName) ? person.FamilyName : $"{person.FamilyName}, {person.GivenName}")
                            </label>
                            <span class="person-email">
                                @if (!string.IsNullOrEmpty(person.Email))
                                {
                                    @person.Email
                                }
                                else
                                {
                                    <span style="color: #ccc;">no email</span>
                                }
                            </span>
                        </li>
                    }
                </ul>
            </div>
        }

        @if (showPersonModal)
        {
            <div class="modal-overlay" @onclick="ClosePersonModal" @onkeydown="HandleModalKeyDown" tabindex="0">
                <div class="modal-content" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h3>@(isEditMode ? "Edit Contact" : "Add New Contact")</h3>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@editPerson" OnValidSubmit="@SavePerson">
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            
                            <div class="form-group">
                                <label>Family Name *</label>
                                <InputText @bind-Value="editPerson.FamilyName" placeholder="Last name" />
                            </div>
                            
                            <div class="form-group">
                                <label>Given Name</label>
                                <InputText @bind-Value="editPerson.GivenName" placeholder="First name" />
                            </div>
                            
                            <div class="form-group">
                                <label>Email</label>
                                <InputText @bind-Value="editPerson.Email" placeholder="email@example.com" type="email" id="person-email-input" />
                            </div>
                            
                            <div class="modal-footer" style="border-top: none; padding: 0;">
                                @if (showDeleteConfirm)
                                {
                                    <span class="delete-confirm-text">Are you sure?</span>
                                    <button type="button" class="btn btn-danger" @onclick="ConfirmDeletePerson">Yes, Delete</button>
                                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete">No</button>
                                }
                                else
                                {
                                    <button type="submit" class="btn btn-primary">@(isEditMode ? "Save Changes" : "Add Contact")</button>
                                    @if (isEditMode && !IsCurrentUserPerson())
                                    {
                                        <button type="button" class="btn btn-danger" @onclick="DeleteCurrentPerson">Delete</button>
                                    }
                                    <button type="button" class="btn btn-secondary" @onclick="ClosePersonModal">Cancel</button>
                                }
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="text-center py-5">
            <p>Please log in to manage contacts.</p>
            <a href="Identity/Account/Login" class="btn btn-primary">Log In</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<Person>? persons;
    private Person editPerson = new();
    private int currentUserId;
    private bool showPersonModal = false;
    private bool isEditMode = false;
    private bool showDeleteConfirm = false;
    private string quickPersonName = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var userId))
            {
                currentUserId = userId;
                await LoadData();
            }
        }
    }

    private async Task LoadData()
    {
        persons = await TodoService.GetUserPersonsAsync(currentUserId);
    }

    private async Task HandleInputKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(quickPersonName))
        {
            await OpenNewPersonModal();
        }
    }

    private void HandleModalKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            ClosePersonModal();
        }
    }

    private async Task OpenNewPersonModal()
    {
        isEditMode = false;
        showPersonModal = true;
        
        editPerson = new Person
        {
            OwningUserId = currentUserId,
            Status = 0,
            FamilyName = quickPersonName
        };
        quickPersonName = "";
        
        await Task.Delay(50);
        await JS.InvokeVoidAsync("eval", "document.getElementById('person-email-input')?.focus()");
    }

    private async Task OpenEditPersonModal(Person person)
    {
        isEditMode = true;
        showPersonModal = true;
        showDeleteConfirm = false;
        
        // Clone the person for editing
        editPerson = new Person
        {
            Id = person.Id,
            OwningUserId = person.OwningUserId,
            UserId = person.UserId,
            FamilyName = person.FamilyName,
            GivenName = person.GivenName,
            Email = person.Email,
            Status = person.Status
        };
        
        await Task.Delay(50);
        await JS.InvokeVoidAsync("eval", "document.getElementById('person-email-input')?.focus()");
    }

    private void ClosePersonModal()
    {
        showPersonModal = false;
        showDeleteConfirm = false;
    }

    private async Task SavePerson()
    {
        if (!string.IsNullOrWhiteSpace(editPerson.FamilyName))
        {
            if (isEditMode)
            {
                await TodoService.UpdatePersonAsync(editPerson);
            }
            else
            {
                await TodoService.CreatePersonAsync(editPerson);
            }
            await LoadData();
            ClosePersonModal();
        }
    }

    private void DeleteCurrentPerson()
    {
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
    }

    private bool IsCurrentUserPerson()
    {
        // Check if the person being edited is linked to the current user
        return editPerson.UserId.HasValue && editPerson.UserId.Value == currentUserId;
    }

    private async Task ConfirmDeletePerson()
    {
        if (editPerson.Id > 0)
        {
            await TodoService.DeletePersonAsync(editPerson.Id);
            await LoadData();
            ClosePersonModal();
        }
    }
}
