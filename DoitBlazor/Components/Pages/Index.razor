@page "/"
@rendermode InteractiveServer
@inject ITodoService TodoService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@inject UserManager<ApplicationUser> UserManager
@using DoitBlazor.Configuration
@using DoitBlazor.Models
@using Microsoft.AspNetCore.Identity

<PageTitle>@AppConfig.BrandName - Todo List</PageTitle>

<AuthorizeView>
    <Authorized Context="authContext">
        <div class="task-input-bar">
            <input type="text" 
                   placeholder="Enter new task..." 
                   @bind="quickTaskCaption"
                   @bind:event="oninput"
                   @onkeydown="HandleTaskInputKeyDown" />
            <span class="late-indicator">@GetLatePercentage()</span>
        </div>

        @if (items == null)
        {
            <div style="padding: 2rem; text-align: center;">
                <em>Loading...</em>
            </div>
        }
        else
        {
            <div class="task-list-compact">
                @if (groupBy == "none")
                {
                    <ul>
                        @foreach (var item in GetFilteredItems())
                        {
                            @RenderCompactTaskItem(item)
                        }
                    </ul>
                }
                else if (groupBy == "duedate")
                {
                    @foreach (var group in GetItemsGroupedByDueDate())
                    {
                        var headerColor = GetDateGroupColor(group.Key);
                        <div class="person-group-header">
                            <span class="due-date-dot" style="color: @headerColor">●</span>
                            @group.Key
                        </div>
                        <ul>
                            @foreach (var item in group)
                            {
                                @RenderCompactTaskItem(item)
                            }
                        </ul>
                    }
                }
                else if (groupBy == "person")
                {
                    @foreach (var group in GetItemsGroupedByPerson())
                    {
                        var groupContact = group.FirstOrDefault()?.Contact;
                        <div class="person-group-header">
                            @group.Key
                            @if (groupContact != null)
                            {
                                <button type="button" class="contact-add-btn" @onclick="@(() => OpenNewTaskModalForContact(groupContact))" title="Add task for this contact">+</button>
                            }
                        </div>
                        <ul>
                            @foreach (var item in group)
                            {
                                @RenderCompactTaskItem(item)
                            }
                        </ul>
                    }
                }
            </div>

            <div class="filter-tabs">
                <ul>
                    <li><button class="@(statusFilter == "all" ? "active" : "")" @onclick='() => statusFilter = "all"'>all</button></li>
                    <li><button class="@(statusFilter == "active" ? "active" : "")" @onclick='() => statusFilter = "active"'>active</button></li>
                    <li><button class="@(statusFilter == "completed" ? "active" : "")" @onclick='() => statusFilter = "completed"'>completed</button></li>
                    <li><button class="@(groupBy == "duedate" ? "active" : "")" @onclick='() => groupBy = "duedate"'>by date</button></li>
                    <li><button class="@(groupBy == "person" ? "active" : "")" @onclick='() => groupBy = "person"'>by contact</button></li>
                </ul>
            </div>
        }

        @if (showNewTaskModal)
        {
            <div class="modal-overlay" @onclick="CloseNewTaskModal" @onkeydown="HandleModalKeyDown">
                <div class="modal-content" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h3>@(isEditMode ? "Edit Task" : "Add New Task")</h3>
                        @if (isEditMode)
                        {
                            <div class="modal-header-actions">
                                <button type="button" 
                                        class="btn-icon @(undoRedoState?.CanUndo == true ? "" : "disabled")" 
                                        @onclick="UndoCurrentItem"
                                        title="@(undoRedoState?.UndoDescription ?? "Undo") (Ctrl+Z)"
                                        disabled="@(undoRedoState?.CanUndo != true)">
                                    ↶
                                </button>
                                <button type="button" 
                                        class="btn-icon @(undoRedoState?.CanRedo == true ? "" : "disabled")" 
                                        @onclick="RedoCurrentItem"
                                        title="@(undoRedoState?.RedoDescription ?? "Redo") (Ctrl+Y)"
                                        disabled="@(undoRedoState?.CanRedo != true)">
                                    ↷
                                </button>
                                <button type="button" 
                                        class="btn-icon @(showHistory ? "active" : "")" 
                                        @onclick="ToggleHistory"
                                        title="Show history">
                                    ⏱
                                </button>
                            </div>
                        }
                    </div>
                    <div class="modal-body">
                        @if (showHistory && isEditMode)
                        {
                            <div class="history-panel">
                                <h4>Edit History</h4>
                                @if (itemHistory == null)
                                {
                                    <p class="history-loading">Loading...</p>
                                }
                                else if (!itemHistory.Any())
                                {
                                    <p class="history-empty">No history yet</p>
                                }
                                else
                                {
                                    <ul class="history-list">
                                        @foreach (var action in itemHistory)
                                        {
                                            <li class="history-item @(action.IsCompacted ? "compacted" : "")">
                                                <span class="history-time">@FormatHistoryTime(action.Timestamp)</span>
                                                <span class="history-description">@action.Description</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                <button type="button" class="btn btn-secondary btn-sm" @onclick="ToggleHistory">
                                    Close History
                                </button>
                            </div>
                        }
                        else
                        {
                            <EditForm Model="@newItem" OnValidSubmit="@SaveItem">
                                <DataAnnotationsValidator />
                                <ValidationSummary />
                                
                                <div class="form-group">
                                    <label>Caption</label>
                                    <InputText @bind-Value="newItem.Caption" placeholder="What needs to be done?" id="task-caption-input" />
                                </div>
                                
                                <div class="form-group">
                                    <label>Due Date</label>
                                    <InputDate @bind-Value="newItem.Due" />
                                </div>
                                
                                <div class="form-group">
                                    <label>Contact</label>
                                    <InputSelect @bind-Value="newItem.ContactId">
                                        <option value="0">Select Contact...</option>
                                        @foreach (var person in persons)
                                        {
                                            <option value="@person.Id">@(string.IsNullOrWhiteSpace(person.GivenName) ? person.FamilyName : $"{person.FamilyName}, {person.GivenName}")</option>
                                        }
                                    </InputSelect>
                                    <button type="button" class="btn btn-secondary" style="margin-top: 0.5rem;" @onclick="ShowQuickAddPerson">
                                        Add New Contact
                                    </button>
                                </div>
                                
                                @if (showQuickAddForm)
                                {
                                    <div style="padding: 1rem; background-color: #f3f4f6; border-radius: 4px; margin-bottom: 1rem;">
                                        <h4 style="margin-top: 0; font-size: 14px;">Quick Add Contact</h4>
                                        <EditForm Model="@quickAddPerson" OnValidSubmit="@QuickAddPerson" Context="quickAddContext">
                                            <div class="form-group">
                                                <label>Family Name *</label>
                                                <InputText @bind-Value="quickAddPerson.FamilyName" placeholder="Last name" id="quick-add-family-name" />
                                            </div>
                                            <div class="form-group">
                                                <label>Given Name</label>
                                                <InputText @bind-Value="quickAddPerson.GivenName" placeholder="First name" id="quick-add-given-name" />
                                            </div>
                                            <div class="form-group">
                                                <label>Email</label>
                                                <InputText @bind-Value="quickAddPerson.Email" placeholder="email@example.com" />
                                            </div>
                                            <button type="submit" class="btn btn-primary">Add Contact</button>
                                            <button type="button" class="btn btn-secondary" style="margin-left: 0.5rem;" @onclick="CancelQuickAdd">Cancel</button>
                                        </EditForm>
                                    </div>
                                }
                                
                                <div class="form-group">
                                    <label>Details</label>
                                    <InputTextArea @bind-Value="newItem.Content" rows="3" id="task-details-input" />
                                </div>
                                
                                <div class="modal-footer" style="border-top: none; padding: 0;">
                                    <button type="submit" class="btn btn-primary">@(isEditMode ? "Save Changes" : "Add Task")</button>
                                    <button type="button" class="btn btn-secondary" @onclick="CloseNewTaskModal">Cancel</button>
                                </div>
                            </EditForm>
                        }
                    </div>
                </div>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="landing-page">
            <div class="landing-hero">
                <h1 class="landing-title">@AppConfig.BrandName</h1>
                <p class="landing-tagline">@AppConfig.Tagline</p>
            </div>

            <div class="landing-auth-card">
                <h2 class="landing-auth-title">Get Started</h2>

                <div class="landing-auth-buttons">
                    <a href="Identity/Account/Login" class="landing-btn landing-btn-primary">
                        <svg class="landing-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/>
                        </svg>
                        Sign In
                    </a>

                    <a href="Identity/Account/Register" class="landing-btn landing-btn-secondary">
                        <svg class="landing-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
                        </svg>
                        Create Account
                    </a>
                </div>

                <div class="landing-oauth-hint">
                    <svg class="landing-oauth-hint-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    <svg class="landing-oauth-hint-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" fill="#333"/>
                    </svg>
                    <span>Google & GitHub sign-in available</span>
                </div>
            </div>

            <div class="landing-features">
                <div class="landing-feature">
                    <div class="landing-feature-icon">✓</div>
                    <div class="landing-feature-text">Track tasks with due dates</div>
                </div>
                <div class="landing-feature">
                    <div class="landing-feature-icon">✓</div>
                    <div class="landing-feature-text">Assign to contacts</div>
                </div>
                <div class="landing-feature">
                    <div class="landing-feature-icon">✓</div>
                    <div class="landing-feature-text">Undo/redo changes</div>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<TodoItem>? items;
    private List<Person> persons = new();
    private TodoItem newItem = new();
    private Person quickAddPerson = new();
    private int currentUserId;
    private Person? currentPerson;
    private bool showQuickAddForm = false;
    private bool showNewTaskModal = false;
    private bool isEditMode = false;
    private int? editingDateItemId = null;
    private string quickTaskCaption = "";
    
    // Undo/redo state
    private UndoRedoState? undoRedoState;
    private List<ActionLog>? itemHistory;
    private bool showHistory = false;
    
    // View controls
    private string statusFilter = "active";
    private string groupBy = "person";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var claimsPrincipal = authState.User;

        if (claimsPrincipal.Identity?.IsAuthenticated == true)
        {
            // Get the actual database user via UserManager
            var user = await UserManager.GetUserAsync(claimsPrincipal);
            
            if (user != null)
            {
                currentUserId = user.Id;
                
                // Ensure user has a Person record
                var email = user.Email ?? user.UserName ?? "unknown@example.com";
                await TodoService.EnsureUserHasPersonAsync(user.Id, email, user.UserName);
                
                await LoadData();
            }
        }
    }

    private async Task LoadData()
    {
        items = await TodoService.GetUserItemsAsync(currentUserId);
        persons = await TodoService.GetUserPersonsAsync(currentUserId);
        currentPerson = await TodoService.FindPersonForUserAsync(currentUserId);
        
        var defaultPersonId = currentPerson?.Id ?? persons.FirstOrDefault()?.Id ?? 0;
        
        newItem = new TodoItem
        {
            UserId = currentUserId,
            AuthorId = defaultPersonId,
            ContactId = defaultPersonId,
            Status = 0,
            Due = DateOnly.FromDateTime(DateTime.Now)
        };
    }

    private IEnumerable<TodoItem> GetFilteredItems()
    {
        if (items == null) return Enumerable.Empty<TodoItem>();
        
        var filtered = statusFilter switch
        {
            "active" => items.Where(i => i.Status == 0),
            "completed" => items.Where(i => i.Status == 1),
            _ => items
        };
        
        return filtered.OrderBy(i => i.Due).ThenBy(i => i.Status);
    }

    private IEnumerable<IGrouping<string, TodoItem>> GetItemsGroupedByDueDate()
    {
        return GetFilteredItems()
            .GroupBy(i => i.Due.HasValue ? i.Due.Value.ToString("yyyy-MM-dd") : "No Due Date")
            .OrderBy(g => g.Key == "No Due Date" ? "9999-99-99" : g.Key);
    }

    private IEnumerable<IGrouping<string, TodoItem>> GetItemsGroupedByPerson()
    {
        return GetFilteredItems()
            .GroupBy(i => i.Contact != null
                ? (string.IsNullOrWhiteSpace(i.Contact.GivenName)
                    ? i.Contact.FamilyName
                    : $"{i.Contact.FamilyName}, {i.Contact.GivenName}")
                : "No Contact")
            .OrderBy(g => g.Key);
    }

    private string GetLatePercentage()
    {
        if (items == null || !items.Any()) return "0% late";
        
        var activeItems = items.Where(i => i.Status == 0).ToList();
        if (!activeItems.Any()) return "0% late";
        
        var lateItems = activeItems.Count(i => i.Due.HasValue && i.Due.Value < DateOnly.FromDateTime(DateTime.Now));
        var percentage = (int)((double)lateItems / activeItems.Count * 100);
        
        return $"{percentage}% late";
    }

    private string GetDueDateColor(TodoItem item)
    {
        if (!item.Due.HasValue) return "#10b981"; // green for no date (future)
        return GetDateColor(item.Due.Value);
    }

    private string GetDateColor(DateOnly date)
    {
        var today = DateOnly.FromDateTime(DateTime.Now);

        if (date < today)
            return "#dc2626"; // red for overdue
        else if (date == today)
            return "#fbbf24"; // yellow for today
        else
            return "#10b981"; // green for future
    }

    private string GetDateGroupColor(string dateKey)
    {
        if (dateKey == "No Due Date") return "#10b981"; // green
        if (DateOnly.TryParse(dateKey, out var date))
            return GetDateColor(date);
        return "#10b981"; // default green
    }

    private string GetContactInitials(Person? contact)
    {
        if (contact == null) return "";

        var givenName = contact.GivenName?.Trim() ?? "";
        var familyName = contact.FamilyName?.Trim() ?? "";

        if (!string.IsNullOrEmpty(givenName) && !string.IsNullOrEmpty(familyName))
        {
            // Both names: "GF" (first letter of each)
            return $"{char.ToUpper(givenName[0])}{char.ToUpper(familyName[0])}";
        }
        else if (!string.IsNullOrEmpty(familyName))
        {
            // Family only: "Fa." (first 2 chars + period)
            var initials = familyName.Length >= 2 ? familyName.Substring(0, 2) : familyName;
            return $"{char.ToUpper(initials[0])}{(initials.Length > 1 ? char.ToLower(initials[1]) : "")}.";
        }
        return "";
    }
    
    private RenderFragment RenderCompactTaskItem(TodoItem item) => __builder =>
    {
        var isCompleted = item.Status == 1;
        var cssClass = isCompleted ? "task-item-compact completed" : "task-item-compact";
        var dotColor = GetDueDateColor(item);
        var isEditingDate = editingDateItemId == item.Id;
    
        <li @key="item.Id" class="@cssClass">
            <input type="checkbox"
                   checked="@isCompleted"
                   @onchange="@(() => ToggleItem(item.Id))" />
            @if (groupBy != "duedate")
            {
                <span class="due-date-dot" style="color: @dotColor">●</span>
            }
            <label title="@item.Caption" @onclick="@(() => OpenEditTaskModalAsync(item))">@item.Caption</label>
            @if (groupBy != "person")
            {
                var initials = GetContactInitials(item.Contact);
                if (!string.IsNullOrEmpty(initials))
                {
                    <span class="task-contact-initials">@initials</span>
                }
            }
            @if (isEditingDate)
            {
                <input type="date" 
                       class="task-date-input"
                       value="@(item.Due?.ToString("yyyy-MM-dd"))"
                       @onchange="@(e => UpdateItemDate(item.Id, e.Value?.ToString()))"
                       @onblur="@(() => editingDateItemId = null)" 
                       autofocus />
            }
            else
            {
                <span class="task-date" @onclick="@(() => StartEditingDate(item.Id))">
                    @if (item.Due.HasValue)
                    {
                        @item.Due.Value.ToString("MM/dd/yyyy")
                    }
                    else
                    {
                        <span style="color: #ccc;">no date</span>
                    }
                </span>
            }
        </li>
    };
    
    private async Task OpenNewTaskModalAsync()
    {
        isEditMode = false;
        showNewTaskModal = true;
        showQuickAddForm = false;
        showHistory = false;
        undoRedoState = null;
        itemHistory = null;
        
        // Pre-fill the caption if user typed something
        if (!string.IsNullOrWhiteSpace(quickTaskCaption))
        {
            newItem.Caption = quickTaskCaption;
            quickTaskCaption = "";
        }
        else
        {
            // Reset for new item
            var defaultPersonId = currentPerson?.Id ?? persons.FirstOrDefault()?.Id ?? 0;
            newItem = new TodoItem
            {
                UserId = currentUserId,
                AuthorId = defaultPersonId,
                ContactId = defaultPersonId,
                Status = 0,
                Due = DateOnly.FromDateTime(DateTime.Now)
            };
        }
        
        // Focus the details field after render
        await Task.Delay(50);
        await JS.InvokeVoidAsync("eval", "document.getElementById('task-details-input')?.focus()");
    }

    private async Task OpenNewTaskModalForContact(Person contact)
    {
        isEditMode = false;
        showNewTaskModal = true;
        showQuickAddForm = false;
        showHistory = false;
        undoRedoState = null;
        itemHistory = null;

        // Reset for new item with pre-selected contact
        newItem = new TodoItem
        {
            UserId = currentUserId,
            AuthorId = currentPerson?.Id ?? contact.Id,
            ContactId = contact.Id,
            Status = 0,
            Due = DateOnly.FromDateTime(DateTime.Now)
        };

        // Focus the caption field after render
        await Task.Delay(50);
        await JS.InvokeVoidAsync("eval", "document.getElementById('task-caption-input')?.focus()");
    }

    private async Task OpenEditTaskModalAsync(TodoItem item)
    {
        isEditMode = true;
        showNewTaskModal = true;
        showQuickAddForm = false;
        showHistory = false;
        
        // Clone the item for editing
        newItem = new TodoItem
        {
            Id = item.Id,
            UserId = item.UserId,
            AuthorId = item.AuthorId,
            ContactId = item.ContactId,
            Caption = item.Caption,
            Content = item.Content,
            Due = item.Due,
            Status = item.Status
        };
        
        // Load undo/redo state
        await LoadUndoRedoState();
        
        // Focus the details field after render
        await Task.Delay(50);
        await JS.InvokeVoidAsync("eval", "document.getElementById('task-details-input')?.focus()");
    }

    private async Task LoadUndoRedoState()
    {
        if (newItem.Id > 0)
        {
            undoRedoState = await TodoService.GetItemUndoRedoStateAsync(currentUserId, newItem.Id);
        }
    }

    private async Task HandleTaskInputKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(quickTaskCaption))
        {
            await OpenNewTaskModalAsync();
        }
    }

    private async Task HandleModalKeyDown(KeyboardEventArgs e)
    {
        // ESC to close modal
        if (e.Key == "Escape")
        {
            CloseNewTaskModal();
            return;
        }
        
        if (!isEditMode || newItem.Id == 0) return;
        
        // Ctrl+Z for Undo
        if (e.CtrlKey && e.Key == "z")
        {
            await UndoCurrentItem();
        }
        // Ctrl+Y for Redo
        else if (e.CtrlKey && e.Key == "y")
        {
            await RedoCurrentItem();
        }
    }

    private async Task UndoCurrentItem()
    {
        if (undoRedoState?.CanUndo != true || newItem.Id == 0) return;
        
        var itemId = newItem.Id;
        var success = await TodoService.UndoItemAsync(currentUserId, itemId);
        if (success)
        {
            // Reload just the items list (not newItem)
            items = await TodoService.GetUserItemsAsync(currentUserId);
            
            // Find the updated item in the refreshed list
            var updatedItem = items?.FirstOrDefault(i => i.Id == itemId);
            if (updatedItem != null)
            {
                // Update newItem with the restored values
                newItem.Caption = updatedItem.Caption;
                newItem.Content = updatedItem.Content;
                newItem.Due = updatedItem.Due;
                newItem.Status = updatedItem.Status;
                newItem.ContactId = updatedItem.ContactId;
                newItem.AuthorId = updatedItem.AuthorId;
            }
            
            await LoadUndoRedoState();
            
            // Refresh history if it's open
            if (showHistory)
            {
                await LoadItemHistory();
            }
            
            StateHasChanged();
        }
    }

    private async Task RedoCurrentItem()
    {
        if (undoRedoState?.CanRedo != true || newItem.Id == 0) return;
        
        var itemId = newItem.Id;
        var success = await TodoService.RedoItemAsync(currentUserId, itemId);
        if (success)
        {
            // Reload just the items list (not newItem)
            items = await TodoService.GetUserItemsAsync(currentUserId);
            
            // Find the updated item in the refreshed list
            var updatedItem = items?.FirstOrDefault(i => i.Id == itemId);
            if (updatedItem != null)
            {
                // Update newItem with the restored values
                newItem.Caption = updatedItem.Caption;
                newItem.Content = updatedItem.Content;
                newItem.Due = updatedItem.Due;
                newItem.Status = updatedItem.Status;
                newItem.ContactId = updatedItem.ContactId;
                newItem.AuthorId = updatedItem.AuthorId;
            }
            
            await LoadUndoRedoState();
            
            // Refresh history if it's open
            if (showHistory)
            {
                await LoadItemHistory();
            }
            
            StateHasChanged();
        }
    }

    private async Task ToggleHistory()
    {
        showHistory = !showHistory;
        
        if (showHistory && newItem.Id > 0)
        {
            await LoadItemHistory();
        }
    }

    private async Task LoadItemHistory()
    {
        itemHistory = await TodoService.GetItemHistoryAsync(newItem.Id);
    }

    private string FormatHistoryTime(DateTime timestamp)
    {
        var local = timestamp.ToLocalTime();
        var now = DateTime.Now;
        
        if (local.Date == now.Date)
        {
            return $"Today {local:h:mm tt}";
        }
        else if (local.Date == now.Date.AddDays(-1))
        {
            return $"Yesterday {local:h:mm tt}";
        }
        else if (local.Year == now.Year)
        {
            return local.ToString("MMM d, h:mm tt");
        }
        else
        {
            return local.ToString("MMM d, yyyy");
        }
    }

    private void CloseNewTaskModal()
    {
        showNewTaskModal = false;
        showQuickAddForm = false;
        showHistory = false;
        undoRedoState = null;
        itemHistory = null;
    }

    private async Task ShowQuickAddPerson()
    {
        quickAddPerson = new Person 
        { 
            OwningUserId = currentUserId,
            Status = 0
        };
        showQuickAddForm = true;
        
        await Task.Delay(50);
        await JS.InvokeVoidAsync("eval", "document.getElementById('quick-add-family-name')?.focus()");
    }

    private async Task QuickAddPerson()
    {
        if (!string.IsNullOrWhiteSpace(quickAddPerson.FamilyName))
        {
            // Save current form state before reloading data
            var savedId = newItem.Id;
            var savedUserId = newItem.UserId;
            var savedCaption = newItem.Caption;
            var savedContent = newItem.Content;
            var savedDue = newItem.Due;
            var savedStatus = newItem.Status;

            await TodoService.CreatePersonAsync(quickAddPerson);
            await LoadData();
            
            // Restore form state that LoadData() wiped
            newItem.Id = savedId;
            newItem.UserId = savedUserId;
            newItem.Caption = savedCaption;
            newItem.Content = savedContent;
            newItem.Due = savedDue;
            newItem.Status = savedStatus;
            
            var newlyAddedPerson = persons.FirstOrDefault(p => 
                p.FamilyName == quickAddPerson.FamilyName && 
                p.GivenName == quickAddPerson.GivenName);
            
            if (newlyAddedPerson != null)
            {
                newItem.ContactId = newlyAddedPerson.Id;
                newItem.AuthorId = newlyAddedPerson.Id;
            }
            
            showQuickAddForm = false;
        }
    }

    private void CancelQuickAdd()
    {
        showQuickAddForm = false;
        quickAddPerson = new();
    }

    private async Task SaveItem()
    {
        if (!string.IsNullOrWhiteSpace(newItem.Caption) && newItem.ContactId > 0 && newItem.AuthorId > 0)
        {
            if (isEditMode)
            {
                await TodoService.UpdateItemAsync(newItem);
                await LoadUndoRedoState(); // Refresh undo/redo state after save
            }
            else
            {
                await TodoService.CreateItemAsync(newItem);
            }
            await LoadData();
            CloseNewTaskModal();
        }
    }

    private async Task ToggleItem(int id)
    {
        await TodoService.ToggleItemStatusAsync(id);
        await LoadData();
    }

    private async Task DeleteItem(int id)
    {
        await TodoService.DeleteItemAsync(id);
        await LoadData();
    }

    private void StartEditingDate(int itemId)
    {
        editingDateItemId = itemId;
    }

    private async Task UpdateItemDate(int itemId, string? dateString)
    {
        editingDateItemId = null;
        
        var item = items?.FirstOrDefault(i => i.Id == itemId);
        if (item == null) return;
        
        if (string.IsNullOrEmpty(dateString))
        {
            item.Due = null;
        }
        else if (DateOnly.TryParse(dateString, out var newDate))
        {
            item.Due = newDate;
        }
        
        await TodoService.UpdateItemAsync(item);
        await LoadData();
    }
}
