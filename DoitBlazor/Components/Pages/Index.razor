@page "/"
@rendermode InteractiveServer
@inject ITodoService TodoService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@inject UserManager<ApplicationUser> UserManager
@using DoitBlazor.Configuration
@using DoitBlazor.Models
@using Microsoft.AspNetCore.Identity

<PageTitle>@AppConfig.BrandName - Todo List</PageTitle>

<AuthorizeView>
    <Authorized Context="authContext">
        <div class="task-input-bar">
            <input type="text" 
                   placeholder="Enter new task..." 
                   @bind="quickTaskCaption"
                   @bind:event="oninput"
                   @onkeydown="HandleTaskInputKeyDown" />
            <span class="late-indicator">@GetLatePercentage()</span>
        </div>

        @if (items == null)
        {
            <div style="padding: 2rem; text-align: center;">
                <em>Loading...</em>
            </div>
        }
        else
        {
            <div class="task-list-compact">
                @if (groupBy == "none")
                {
                    <ul>
                        @foreach (var item in GetFilteredItems())
                        {
                            @RenderCompactTaskItem(item)
                        }
                    </ul>
                }
                else if (groupBy == "duedate")
                {
                    @foreach (var group in GetItemsGroupedByDueDate())
                    {
                        <div class="person-group-header">@group.Key</div>
                        <ul>
                            @foreach (var item in group)
                            {
                                @RenderCompactTaskItem(item)
                            }
                        </ul>
                    }
                }
                else if (groupBy == "person")
                {
                    @foreach (var group in GetItemsGroupedByPerson())
                    {
                        <div class="person-group-header">@group.Key</div>
                        <ul>
                            @foreach (var item in group)
                            {
                                @RenderCompactTaskItem(item)
                            }
                        </ul>
                    }
                }
            </div>

            <div class="filter-tabs">
                <ul>
                    <li><button class="@(statusFilter == "all" ? "active" : "")" @onclick='() => statusFilter = "all"'>all</button></li>
                    <li><button class="@(statusFilter == "active" ? "active" : "")" @onclick='() => statusFilter = "active"'>active</button></li>
                    <li><button class="@(statusFilter == "completed" ? "active" : "")" @onclick='() => statusFilter = "completed"'>completed</button></li>
                    <li><button class="@(groupBy == "duedate" ? "active" : "")" @onclick='() => groupBy = "duedate"'>by date</button></li>
                    <li><button class="@(groupBy == "person" ? "active" : "")" @onclick='() => groupBy = "person"'>by contact</button></li>
                </ul>
            </div>
        }

        @if (showNewTaskModal)
        {
            <div class="modal-overlay" @onclick="CloseNewTaskModal" @onkeydown="HandleModalKeyDown">
                <div class="modal-content" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h3>@(isEditMode ? "Edit Task" : "Add New Task")</h3>
                        @if (isEditMode)
                        {
                            <div class="modal-header-actions">
                                <button type="button" 
                                        class="btn-icon @(undoRedoState?.CanUndo == true ? "" : "disabled")" 
                                        @onclick="UndoCurrentItem"
                                        title="@(undoRedoState?.UndoDescription ?? "Undo") (Ctrl+Z)"
                                        disabled="@(undoRedoState?.CanUndo != true)">
                                    ‚Ü∂
                                </button>
                                <button type="button" 
                                        class="btn-icon @(undoRedoState?.CanRedo == true ? "" : "disabled")" 
                                        @onclick="RedoCurrentItem"
                                        title="@(undoRedoState?.RedoDescription ?? "Redo") (Ctrl+Y)"
                                        disabled="@(undoRedoState?.CanRedo != true)">
                                    ‚Ü∑
                                </button>
                                <button type="button" 
                                        class="btn-icon @(showHistory ? "active" : "")" 
                                        @onclick="ToggleHistory"
                                        title="Show history">
                                    ‚è±
                                </button>
                            </div>
                        }
                    </div>
                    <div class="modal-body">
                        @if (showHistory && isEditMode)
                        {
                            <div class="history-panel">
                                <h4>Edit History</h4>
                                @if (itemHistory == null)
                                {
                                    <p class="history-loading">Loading...</p>
                                }
                                else if (!itemHistory.Any())
                                {
                                    <p class="history-empty">No history yet</p>
                                }
                                else
                                {
                                    <ul class="history-list">
                                        @foreach (var action in itemHistory)
                                        {
                                            <li class="history-item @(action.IsCompacted ? "compacted" : "")">
                                                <span class="history-time">@FormatHistoryTime(action.Timestamp)</span>
                                                <span class="history-description">@action.Description</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                <button type="button" class="btn btn-secondary btn-sm" @onclick="ToggleHistory">
                                    Close History
                                </button>
                            </div>
                        }
                        else
                        {
                            <EditForm Model="@newItem" OnValidSubmit="@SaveItem">
                                <DataAnnotationsValidator />
                                <ValidationSummary />
                                
                                <div class="form-group">
                                    <label>Caption</label>
                                    <InputText @bind-Value="newItem.Caption" placeholder="What needs to be done?" />
                                </div>
                                
                                <div class="form-group">
                                    <label>Due Date</label>
                                    <InputDate @bind-Value="newItem.Due" />
                                </div>
                                
                                <div class="form-group">
                                    <label>Contact</label>
                                    <InputSelect @bind-Value="newItem.ContactId">
                                        <option value="0">Select Contact...</option>
                                        @foreach (var person in persons)
                                        {
                                            <option value="@person.Id">@(string.IsNullOrWhiteSpace(person.GivenName) ? person.FamilyName : $"{person.FamilyName}, {person.GivenName}")</option>
                                        }
                                    </InputSelect>
                                    <button type="button" class="btn btn-secondary" style="margin-top: 0.5rem;" @onclick="ShowQuickAddPerson">
                                        Add New Contact
                                    </button>
                                </div>
                                
                                @if (showQuickAddForm)
                                {
                                    <div style="padding: 1rem; background-color: #f3f4f6; border-radius: 4px; margin-bottom: 1rem;">
                                        <h4 style="margin-top: 0; font-size: 14px;">Quick Add Contact</h4>
                                        <EditForm Model="@quickAddPerson" OnValidSubmit="@QuickAddPerson" Context="quickAddContext">
                                            <div class="form-group">
                                                <label>Family Name *</label>
                                                <InputText @bind-Value="quickAddPerson.FamilyName" placeholder="Last name" />
                                            </div>
                                            <div class="form-group">
                                                <label>Given Name</label>
                                                <InputText @bind-Value="quickAddPerson.GivenName" placeholder="First name" />
                                            </div>
                                            <div class="form-group">
                                                <label>Email</label>
                                                <InputText @bind-Value="quickAddPerson.Email" placeholder="email@example.com" />
                                            </div>
                                            <button type="submit" class="btn btn-primary">Add Contact</button>
                                            <button type="button" class="btn btn-secondary" style="margin-left: 0.5rem;" @onclick="CancelQuickAdd">Cancel</button>
                                        </EditForm>
                                    </div>
                                }
                                
                                <div class="form-group">
                                    <label>Details</label>
                                    <InputTextArea @bind-Value="newItem.Content" rows="3" id="task-details-input" />
                                </div>
                                
                                <div class="modal-footer" style="border-top: none; padding: 0;">
                                    <button type="submit" class="btn btn-primary">@(isEditMode ? "Save Changes" : "Add Task")</button>
                                    <button type="button" class="btn btn-secondary" @onclick="CloseNewTaskModal">Cancel</button>
                                </div>
                            </EditForm>
                        }
                    </div>
                </div>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="text-center py-5">
            <h1 class="display-4 mb-4">Welcome to @AppConfig.BrandName</h1>
            <p class="lead mb-4">@AppConfig.Tagline</p>
            <p class="mb-4">Organize your tasks, track due dates, and collaborate with contacts.</p>
            
            <div class="d-flex gap-3 justify-content-center">
                <a href="Identity/Account/Register" class="btn btn-primary btn-lg">
                    Get Started - Register
                </a>
                <a href="Identity/Account/Login" class="btn btn-secondary btn-lg">
                    Log In
                </a>
            </div>
            
            <div class="mt-5">
                <h4>Features:</h4>
                <div class="row mt-4">
                    <div class="col-md-4">
                        <h5>üìã Task Management</h5>
                        <p>Create, organize, and track your todos</p>
                    </div>
                    <div class="col-md-4">
                        <h5>üìÖ Due Dates</h5>
                        <p>Never miss a deadline with visual reminders</p>
                    </div>
                    <div class="col-md-4">
                        <h5>üë• Contacts</h5>
                        <p>Assign tasks to people and track responsibilities</p>
                    </div>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<TodoItem>? items;
    private List<Person> persons = new();
    private TodoItem newItem = new();
    private Person quickAddPerson = new();
    private int currentUserId;
    private Person? currentPerson;
    private bool showQuickAddForm = false;
    private bool showNewTaskModal = false;
    private bool isEditMode = false;
    private int? editingDateItemId = null;
    private string quickTaskCaption = "";
    
    // Undo/redo state
    private UndoRedoState? undoRedoState;
    private List<ActionLog>? itemHistory;
    private bool showHistory = false;
    
    // View controls
    private string statusFilter = "active";
    private string groupBy = "duedate";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var claimsPrincipal = authState.User;

        if (claimsPrincipal.Identity?.IsAuthenticated == true)
        {
            // Get the actual database user via UserManager
            var user = await UserManager.GetUserAsync(claimsPrincipal);
            
            if (user != null)
            {
                currentUserId = user.Id;
                
                // Ensure user has a Person record
                var email = user.Email ?? user.UserName ?? "unknown@example.com";
                await TodoService.EnsureUserHasPersonAsync(user.Id, email, user.UserName);
                
                await LoadData();
            }
        }
    }

    private async Task LoadData()
    {
        items = await TodoService.GetUserItemsAsync(currentUserId);
        persons = await TodoService.GetUserPersonsAsync(currentUserId);
        currentPerson = await TodoService.FindPersonForUserAsync(currentUserId);
        
        var defaultPersonId = currentPerson?.Id ?? persons.FirstOrDefault()?.Id ?? 0;
        
        newItem = new TodoItem
        {
            UserId = currentUserId,
            AuthorId = defaultPersonId,
            ContactId = defaultPersonId,
            Status = 0,
            Due = DateOnly.FromDateTime(DateTime.Now)
        };
    }

    private IEnumerable<TodoItem> GetFilteredItems()
    {
        if (items == null) return Enumerable.Empty<TodoItem>();
        
        var filtered = statusFilter switch
        {
            "active" => items.Where(i => i.Status == 0),
            "completed" => items.Where(i => i.Status == 1),
            _ => items
        };
        
        return filtered.OrderBy(i => i.Due).ThenBy(i => i.Status);
    }

    private IEnumerable<IGrouping<string, TodoItem>> GetItemsGroupedByDueDate()
    {
        return GetFilteredItems()
            .GroupBy(i => i.Due.HasValue ? i.Due.Value.ToString("yyyy-MM-dd") : "No Due Date")
            .OrderBy(g => g.Key == "No Due Date" ? "9999-99-99" : g.Key);
    }

    private IEnumerable<IGrouping<string, TodoItem>> GetItemsGroupedByPerson()
    {
        return GetFilteredItems()
            .GroupBy(i => i.Contact != null 
                ? $"{i.Contact.FamilyName}, {i.Contact.GivenName}" 
                : "No Contact")
            .OrderBy(g => g.Key);
    }

    private string GetLatePercentage()
    {
        if (items == null || !items.Any()) return "0% late";
        
        var activeItems = items.Where(i => i.Status == 0).ToList();
        if (!activeItems.Any()) return "0% late";
        
        var lateItems = activeItems.Count(i => i.Due.HasValue && i.Due.Value < DateOnly.FromDateTime(DateTime.Now));
        var percentage = (int)((double)lateItems / activeItems.Count * 100);
        
        return $"{percentage}% late";
    }

    private string GetDueDateColor(TodoItem item)
    {
        if (!item.Due.HasValue) return "#10b981"; // green for no date (future)
    
        var today = DateOnly.FromDateTime(DateTime.Now);
    
        if (item.Due.Value < today)
            return "#dc2626"; // red for overdue
        else if (item.Due.Value == today)
            return "#fbbf24"; // yellow for today
        else
            return "#10b981"; // green for future
    }
    
    private RenderFragment RenderCompactTaskItem(TodoItem item) => __builder =>
    {
        var isCompleted = item.Status == 1;
        var cssClass = isCompleted ? "task-item-compact completed" : "task-item-compact";
        var dotColor = GetDueDateColor(item);
        var isEditingDate = editingDateItemId == item.Id;
    
        <li class="@cssClass">
            <input type="checkbox" 
                   checked="@isCompleted"
                   @onchange="@(() => ToggleItem(item.Id))" />
            <span class="due-date-dot" style="color: @dotColor">‚óè</span>
            <label @onclick="@(() => OpenEditTaskModalAsync(item))">@item.Caption</label>
            @if (isEditingDate)
            {
                <input type="date" 
                       class="task-date-input"
                       value="@(item.Due?.ToString("yyyy-MM-dd"))"
                       @onchange="@(e => UpdateItemDate(item.Id, e.Value?.ToString()))"
                       @onblur="@(() => editingDateItemId = null)" 
                       autofocus />
            }
            else
            {
                <span class="task-date" @onclick="@(() => StartEditingDate(item.Id))">
                    @if (item.Due.HasValue)
                    {
                        @item.Due.Value.ToString("MM/dd/yyyy")
                    }
                    else
                    {
                        <span style="color: #ccc;">no date</span>
                    }
                </span>
            }
        </li>
    };
    
    private async Task OpenNewTaskModalAsync()
    {
        isEditMode = false;
        showNewTaskModal = true;
        showQuickAddForm = false;
        showHistory = false;
        undoRedoState = null;
        itemHistory = null;
        
        // Pre-fill the caption if user typed something
        if (!string.IsNullOrWhiteSpace(quickTaskCaption))
        {
            newItem.Caption = quickTaskCaption;
            quickTaskCaption = "";
        }
        else
        {
            // Reset for new item
            var defaultPersonId = currentPerson?.Id ?? persons.FirstOrDefault()?.Id ?? 0;
            newItem = new TodoItem
            {
                UserId = currentUserId,
                AuthorId = defaultPersonId,
                ContactId = defaultPersonId,
                Status = 0,
                Due = DateOnly.FromDateTime(DateTime.Now)
            };
        }
        
        // Focus the details field after render
        await Task.Delay(50);
        await JS.InvokeVoidAsync("eval", "document.getElementById('task-details-input')?.focus()");
    }

    private async Task OpenEditTaskModalAsync(TodoItem item)
    {
        isEditMode = true;
        showNewTaskModal = true;
        showQuickAddForm = false;
        showHistory = false;
        
        // Clone the item for editing
        newItem = new TodoItem
        {
            Id = item.Id,
            UserId = item.UserId,
            AuthorId = item.AuthorId,
            ContactId = item.ContactId,
            Caption = item.Caption,
            Content = item.Content,
            Due = item.Due,
            Status = item.Status
        };
        
        // Load undo/redo state
        await LoadUndoRedoState();
        
        // Focus the details field after render
        await Task.Delay(50);
        await JS.InvokeVoidAsync("eval", "document.getElementById('task-details-input')?.focus()");
    }

    private async Task LoadUndoRedoState()
    {
        if (newItem.Id > 0)
        {
            undoRedoState = await TodoService.GetItemUndoRedoStateAsync(currentUserId, newItem.Id);
        }
    }

    private async Task HandleTaskInputKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(quickTaskCaption))
        {
            await OpenNewTaskModalAsync();
        }
    }

    private async Task HandleModalKeyDown(KeyboardEventArgs e)
    {
        // ESC to close modal
        if (e.Key == "Escape")
        {
            CloseNewTaskModal();
            return;
        }
        
        if (!isEditMode || newItem.Id == 0) return;
        
        // Ctrl+Z for Undo
        if (e.CtrlKey && e.Key == "z")
        {
            await UndoCurrentItem();
        }
        // Ctrl+Y for Redo
        else if (e.CtrlKey && e.Key == "y")
        {
            await RedoCurrentItem();
        }
    }

    private async Task UndoCurrentItem()
    {
        if (undoRedoState?.CanUndo != true || newItem.Id == 0) return;
        
        var itemId = newItem.Id;
        var success = await TodoService.UndoItemAsync(currentUserId, itemId);
        if (success)
        {
            // Reload just the items list (not newItem)
            items = await TodoService.GetUserItemsAsync(currentUserId);
            
            // Find the updated item in the refreshed list
            var updatedItem = items?.FirstOrDefault(i => i.Id == itemId);
            if (updatedItem != null)
            {
                // Update newItem with the restored values
                newItem.Caption = updatedItem.Caption;
                newItem.Content = updatedItem.Content;
                newItem.Due = updatedItem.Due;
                newItem.Status = updatedItem.Status;
                newItem.ContactId = updatedItem.ContactId;
                newItem.AuthorId = updatedItem.AuthorId;
            }
            
            await LoadUndoRedoState();
            
            // Refresh history if it's open
            if (showHistory)
            {
                await LoadItemHistory();
            }
            
            StateHasChanged();
        }
    }

    private async Task RedoCurrentItem()
    {
        if (undoRedoState?.CanRedo != true || newItem.Id == 0) return;
        
        var itemId = newItem.Id;
        var success = await TodoService.RedoItemAsync(currentUserId, itemId);
        if (success)
        {
            // Reload just the items list (not newItem)
            items = await TodoService.GetUserItemsAsync(currentUserId);
            
            // Find the updated item in the refreshed list
            var updatedItem = items?.FirstOrDefault(i => i.Id == itemId);
            if (updatedItem != null)
            {
                // Update newItem with the restored values
                newItem.Caption = updatedItem.Caption;
                newItem.Content = updatedItem.Content;
                newItem.Due = updatedItem.Due;
                newItem.Status = updatedItem.Status;
                newItem.ContactId = updatedItem.ContactId;
                newItem.AuthorId = updatedItem.AuthorId;
            }
            
            await LoadUndoRedoState();
            
            // Refresh history if it's open
            if (showHistory)
            {
                await LoadItemHistory();
            }
            
            StateHasChanged();
        }
    }

    private async Task ToggleHistory()
    {
        showHistory = !showHistory;
        
        if (showHistory && newItem.Id > 0)
        {
            await LoadItemHistory();
        }
    }

    private async Task LoadItemHistory()
    {
        itemHistory = await TodoService.GetItemHistoryAsync(newItem.Id);
    }

    private string FormatHistoryTime(DateTime timestamp)
    {
        var local = timestamp.ToLocalTime();
        var now = DateTime.Now;
        
        if (local.Date == now.Date)
        {
            return $"Today {local:h:mm tt}";
        }
        else if (local.Date == now.Date.AddDays(-1))
        {
            return $"Yesterday {local:h:mm tt}";
        }
        else if (local.Year == now.Year)
        {
            return local.ToString("MMM d, h:mm tt");
        }
        else
        {
            return local.ToString("MMM d, yyyy");
        }
    }

    private void CloseNewTaskModal()
    {
        showNewTaskModal = false;
        showQuickAddForm = false;
        showHistory = false;
        undoRedoState = null;
        itemHistory = null;
    }

    private void ShowQuickAddPerson()
    {
        quickAddPerson = new Person 
        { 
            OwningUserId = currentUserId,
            Status = 0
        };
        showQuickAddForm = true;
    }

    private async Task QuickAddPerson()
    {
        if (!string.IsNullOrWhiteSpace(quickAddPerson.FamilyName))
        {
            // Save current form state before reloading data
            var savedCaption = newItem.Caption;
            var savedContent = newItem.Content;
            var savedDue = newItem.Due;
            var savedStatus = newItem.Status;
            
            await TodoService.CreatePersonAsync(quickAddPerson);
            await LoadData();
            
            // Restore form state that LoadData() wiped
            newItem.Caption = savedCaption;
            newItem.Content = savedContent;
            newItem.Due = savedDue;
            newItem.Status = savedStatus;
            
            var newlyAddedPerson = persons.FirstOrDefault(p => 
                p.FamilyName == quickAddPerson.FamilyName && 
                p.GivenName == quickAddPerson.GivenName);
            
            if (newlyAddedPerson != null)
            {
                newItem.ContactId = newlyAddedPerson.Id;
                newItem.AuthorId = newlyAddedPerson.Id;
            }
            
            showQuickAddForm = false;
        }
    }

    private void CancelQuickAdd()
    {
        showQuickAddForm = false;
        quickAddPerson = new();
    }

    private async Task SaveItem()
    {
        if (!string.IsNullOrWhiteSpace(newItem.Caption) && newItem.ContactId > 0 && newItem.AuthorId > 0)
        {
            if (isEditMode)
            {
                await TodoService.UpdateItemAsync(newItem);
                await LoadUndoRedoState(); // Refresh undo/redo state after save
            }
            else
            {
                await TodoService.CreateItemAsync(newItem);
            }
            await LoadData();
            CloseNewTaskModal();
        }
    }

    private async Task ToggleItem(int id)
    {
        await TodoService.ToggleItemStatusAsync(id);
        await LoadData();
    }

    private async Task DeleteItem(int id)
    {
        await TodoService.DeleteItemAsync(id);
        await LoadData();
    }

    private void StartEditingDate(int itemId)
    {
        editingDateItemId = itemId;
    }

    private async Task UpdateItemDate(int itemId, string? dateString)
    {
        editingDateItemId = null;
        
        var item = items?.FirstOrDefault(i => i.Id == itemId);
        if (item == null) return;
        
        if (string.IsNullOrEmpty(dateString))
        {
            item.Due = null;
        }
        else if (DateOnly.TryParse(dateString, out var newDate))
        {
            item.Due = newDate;
        }
        
        await TodoService.UpdateItemAsync(item);
        await LoadData();
    }
}
